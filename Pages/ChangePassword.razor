@page "/change-password"

<MudContainer Class="mt-8">
    <MudAppBar Color="Color.Primary" Elevation="4">
        <MudTypography Typo="Typo.h6">Change Password</MudTypography>
    </MudAppBar>
    <MudContainer>
        @if (_globalState.CurrentUser != null && _globalState.CurrentUser.HasInitialPassword)
        {
            <MudAlert Severity="Severity.Warning" Message="You are using the initial password. Please change it." />
        }
        <MudForm @onsubmit="ChangePasswordHandler">
            <MudTextField Label="Current Password" @bind-Value="_currentPassword" Type="MudTextFieldType.Password" Required="true" />
            <MudTextField Label="New Password" @bind-Value="_newPassword" Type="MudTextFieldType.Password" Required="true" />
            @if (!string.IsNullOrEmpty(_successMessage))
            {
                <MudAlert  Message="@_successMessage" />
            }
            else if (!string.IsNullOrEmpty(_errorMessage))
            {
                <MudAlert Message="@_errorMessage" />
            }
            <MudButton Type="ButtonType.Submit" Color="Color.Primary" Class="mt-4">
                <MudIcon Icon="@Icons.Material.Filled.Check" Class="mr-1" /> Submit
            </MudButton>
        </MudForm>
    </MudContainer>
</MudContainer>

@code {
    [CascadingParameter]
    private GlobalState _globalState { get; set; }
    private string _currentPassword { get; set; }
    private string _newPassword { get; set; }
    private string _errorMessage = "";
    private string _successMessage = "";

    protected override void OnInitialized()
    {
        _errorMessage = "";
        _successMessage = "";
        Console.WriteLine("ChangePasswordHandler invoked");
    }

    private void ChangePasswordHandler()
    {
        try
        {
            _errorMessage = "sdfghjk";
            _successMessage = "";
            Console.WriteLine("ChangePasswordHandler invoked");
            
            _globalState.CurrentUser = UsersService.ChangePassword(_globalState.CurrentUser.ID, _currentPassword, _newPassword);
            _currentPassword = "";
            _newPassword = "";  
            _successMessage = "The password has been changed successfully.";
        }
        catch (Exception e)
        {
            _errorMessage = e.Message;
            Console.WriteLine(e);
        }
    }
}
